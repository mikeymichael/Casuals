let workers = JSON.parse(localStorage.getItem('workersData')) || [{
  name: 'John Doe', idNumber: '001', phone: '0712345678', residence: 'Nairobi',
  attendance: [
    { date: '2025-07-01', pay: 500 },
    { date: '2025-07-02', pay: 600 },
    { date: '2025-07-03' }
  ]
}];

function saveWorkers() {
  localStorage.setItem('workersData', JSON.stringify(workers));
}

function navigate(id) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  const section = document.getElementById(id);
  if (section) section.classList.add('active');
  if (id === 'dashboard') renderDashboard();
  if (id === 'workers') renderWorkers();
  if (id === 'attendance') renderAttendanceOptions();
}

function renderDashboard() {
  const now = new Date();
  const month = now.getMonth();
  const thisWeek = [...Array(7)].map((_, i) => {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    return d.toISOString().split('T')[0];
  });

  let total = 0, monthTotal = 0, unpaid = 0;
  let lastAtt = '-', maxPay = 0, topWorker = '-';
  workers.forEach(w => {
    let weekly = 0, missed = 0, mPay = 0;
    (w.attendance || []).forEach(a => {
      if (thisWeek.includes(a.date)) weekly += a.pay || 0;
      if (!a.pay) missed++;
      if (new Date(a.date).getMonth() === month) mPay += a.pay || 0;
      if (!lastAtt || new Date(a.date) > new Date(lastAtt)) lastAtt = a.date;
    });
    if (mPay > maxPay) { maxPay = mPay; topWorker = w.name; }
    total += weekly;
    monthTotal += mPay;
    unpaid += missed;
  });

  document.getElementById('dash-cards').innerHTML = `
    <div class="card positive"><strong>Total Workers</strong><br>${workers.length}</div>
    <div class="card positive"><strong>Total Weekly Pay</strong><br>KSH ${total}</div>
    <div class="card positive"><strong>Total Monthly Pay</strong><br>KSH ${monthTotal}</div>
    <div class="card danger"><strong>Unpaid Days</strong><br>${unpaid}</div>
    <div class="card warning"><strong>Top Earner</strong><br>${topWorker} (${maxPay})</div>
    <div class="card"><strong>Last Attendance</strong><br>${lastAtt}</div>
  `;

  renderChart();
}

function renderChart() {
  const ctx = document.getElementById('payChart').getContext('2d');
  const days = [...Array(7)].map((_, i) => {
    const d = new Date();
    d.setDate(d.getDate() - i);
    return d.toISOString().split('T')[0];
  }).reverse();

  const labels = days.map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short' }));
  const totals = days.map(date => {
    return workers.reduce((sum, w) =>
      sum + (w.attendance || []).filter(a => a.date === date).reduce((s, a) => s + (a.pay || 0), 0), 0);
  });

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Pay (KSH)', data: totals, backgroundColor: '#0a74da' }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function renderWorkers() {
  const rows = workers.map((w, i) => `
    <tr>
      <td>${w.name}</td>
      <td>${w.idNumber}</td>
      <td>${w.phone}</td>
      <td>${w.residence}</td>
      <td>
        <button onclick="deleteWorker(${i})">Delete</button>
      </td>
    </tr>
  `);
  document.querySelector('#workers-table tbody').innerHTML = rows.join('');
}

function deleteWorker(index) {
  if (confirm("Are you sure you want to delete this worker?")) {
    workers.splice(index, 1);
    saveWorkers();
    renderWorkers();
    renderDashboard();
  }
}

function renderAttendanceOptions() {
  const select = document.getElementById('select-worker');
  select.innerHTML = workers.map((w, i) => `<option value="${i}">${w.name} (${w.idNumber})</option>`).join('');
}

document.getElementById('worker-form').addEventListener('submit', e => {
  e.preventDefault();
  const name = document.getElementById('name').value;
  const id = document.getElementById('idNumber').value;
  const phone = document.getElementById('phone').value;
  const residence = document.getElementById('residence').value;
  workers.push({ name, idNumber: id, phone, residence, attendance: [] });
  saveWorkers();
  e.target.reset();
  renderWorkers();
  alert('Worker added!');
});

document.getElementById('attendance-form').addEventListener('submit', e => {
  e.preventDefault();
  const index = document.getElementById('select-worker').value;
  const date = document.getElementById('attDate').value;
  const pay = parseFloat(document.getElementById('attPay').value);
  if (!date) return alert("Please select a date");
  workers[index].attendance.push({ date, ...(isNaN(pay) ? {} : { pay }) });
  saveWorkers();
  e.target.reset();
  alert("Attendance added");
  renderDashboard();
});

navigate('dashboard');
